name: Run all necessary checks for pull request

on:
    pull_request:
        branches:
            - main
    workflow_dispatch:

permissions:
  contents: read
  actions: read
  checks: write

jobs:
  circular_dependency:
    runs-on: ubuntu-latest
    name: circular dependency
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Install dependencies ğŸ§©
        uses: ./.github/actions/install-dependencies
      - name: Check circular dependencies ğŸ”—
        run: npm run madge

  lint:
    name: eslint
    runs-on: ubuntu-latest
    needs: circular_dependency
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Install dependencies ğŸ§©
        uses: ./.github/actions/install-dependencies
      - name: Run eslint ğŸ‘•
        run: npm run lint

  tests:
    name: Run tests
    runs-on: ubuntu-latest
    needs: circular_dependency
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Install dependencies ğŸ§©
        uses: ./.github/actions/install-dependencies
      - name: Run tests ğŸ§ª
        run: npm run test:ci
      - name: Test report âœ…
        uses: dorny/test-reporter@v1
        if: success() || failure()
        with:
          name: JEST Tests
          path: junit.xml
          reporter: jest-junit
          fail-on-error: 'false'
