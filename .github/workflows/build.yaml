name: Create binary files for every supported platform
on:
  release:
    types: [published]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: macos-12 # Intel Mac
            output: spctl-macos-x64
          - os: ubuntu-20.04
            output: spctl-linux-x64
          - os: macos-14 # M1 Mac
            output: spctl-macos-arm64
    steps:
    - name: Checkout ğŸ›ï¸
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}
    - name: Install dependencies ğŸ§©
      uses: ./.github/actions/install-dependencies
    - name: Build binary
      run: |
          npm run build
          mv ./dist/provider_tools ./dist/${{ matrix.output }}
    - name: "Save build results for release job"
      uses: actions/upload-artifact@v2
      with:
        name: release
        path: dist/spctl-*
        retention-days: 1

  create-release:
    runs-on: ubuntu-20.04
    needs: [build]
    steps:
      - name: "Download artifacts"
        uses: actions/download-artifact@v2
        with:
          name: release
      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            spctl-macos-x64
            spctl-linux-x64
            spctl-macos-arm64
