name: Create binary files for every supported platform
on:
  release:
    types: [published]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: macos-12 # Intel Mac
            output: provider-tools-macos-x64
          - os: ubuntu-20.04
            output: provider-tools-linux-x64
          - os: macos-14 # M1 Mac
            output: provider-tools-macos-arm64
          - os: windows-latest
            output: provider-tools-win-x64
    steps:
    - name: Checkout üõéÔ∏è
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}
    - name: Install dependencies üß©
      uses: ./.github/actions/install-dependencies
    - name: Build binary
      run: |
        npm run build
        if [ "${{ matrix.os }}" == "windows-latest" ]; then
          mv ./dist/provider_tools.exe ./dist/${{ matrix.output }}
        else
          mv ./dist/provider_tools ./dist/${{ matrix.output }}
        fi
      shell: bash
    - name: "Save build results for release job"
      uses: actions/upload-artifact@v2
      with:
        name: release
        path: dist/provider-tools-*
        retention-days: 1

  create-release:
    runs-on: ubuntu-20.04
    needs: [build]
    steps:
      - name: "Download artifacts"
        uses: actions/download-artifact@v2
        with:
          name: release
      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            provider-tools-macos-x64
            provider-tools-linux-x64
            provider-tools-macos-arm64
            provider-tools-win-x64
